# Playwright Testing Container
# Provides a consistent environment for visual regression testing

FROM mcr.microsoft.com/playwright:v1.40.0-focal

# Set working directory
WORKDIR /app

# Install Node.js dependencies for Playwright
COPY tests/visual/package*.json ./
RUN npm ci

# Install additional tools for test execution
RUN apt-get update && apt-get install -y \
    curl \
    jq \
    && rm -rf /var/lib/apt/lists/*

# Copy Playwright configuration and tests
COPY tests/visual/ ./

# Create directories for reports and screenshots
RUN mkdir -p reports/visual_reports \
    && mkdir -p screenshots/baseline \
    && mkdir -p screenshots/actual

# Install Playwright browsers
RUN npx playwright install --with-deps chromium

# Set environment variables
ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
ENV NODE_ENV=test
ENV CI=true

# Create non-root user for security
RUN groupadd -r playwright && useradd -r -g playwright -G audio,video playwright \
    && mkdir -p /home/playwright/Downloads \
    && chown -R playwright:playwright /home/playwright \
    && chown -R playwright:playwright /app

# Switch to non-root user
USER playwright

# Expose port for debugging (optional)
EXPOSE 9323

# Default command
CMD ["npx", "playwright", "test"]

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD npx playwright --version || exit 1